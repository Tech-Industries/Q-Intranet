
@{
    ViewBag.Title = "Index";
}
<div class="row">
    <div class="col-lg-12">
        <div class="wrapper wrapper-content animated fadeInUp" style="padding-bottom: 0;">

            <div class="ibox">
                <div class="ibox-title">
                    <h5>Onboarding - <span data-bind="text: OnboardingParts().length"></span> Parts Found</h5>
                    <div class="ibox-tools">
                        <button class="btn btn-primary btn-sm" id="archive-toggle">Archive</button>
                    </div>
                </div>
                <div class="ibox-content">
                    <div data-bind="if: OnboardingParts().length == 0">
                        <h1>No Parts Found</h1>
                    </div>
                    <div class="row">
                        <div class="col-md-10 col-md-offset-2">
                            <div data-bind="foreach: {data: OnboardingTasks()[0]}">
                                <div class="onboard-task-header" data-bind="text: TaskDescription"></div>
                            </div>
                        </div>
                    </div>
                    <div style="height: 600px; white-space: nowrap;">
                        <div class="full-height-scroll">
                            <div data-bind="foreach: {data: OnboardingParts(), as: 'part' }">
                                <div class="row onboard-part-item">
                                    <div class="col-md-2">
                                        <div style="float: left">
                                            <div style="width: 220px; height: 20px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">
                                                <h5 data-bind="text: part.PartNumber"></h5>
                                            </div>
                                            <div style="width: 220px; height: 20px; text-overflow: ellipsis;white-space: nowrap; overflow: hidden;">
                                                <h5 data-bind="text: part.PartDescription"></h5>
                                            </div>
                                            <div style="width: 220px; height: 20px; text-overflow: ellipsis;white-space: nowrap; overflow: hidden;">
                                                <span data-bind="if: part.FirstArticleJobNumber == null || part.FirstArticleJobNumber == ''"><button class="btn btn-danger btn-xs btn-assign-job" data-bind="attr:{partid: part.RecordNumber, partnumber: part.PartNumber}">Assign Job</button></span>
                                                <span data-bine="if: part.FirstArticleJobNumber != ''"><span data-bind="text: part.FirstArticleJobNumber"></span></span>
                                            </div>
                                            <div style="width: 220px; height: 20px; text-overflow: ellipsis;white-space: nowrap; overflow: hidden;">
                                                <button class="btn btn-primary btn-xs part-detail" data-bind="attr:{'partid': part.RecordNumber}">Open</button>
                                            </div>
                                        </div>
                                        @*<div style="width: 60px; height: 80px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;float: left; padding: 0 5px;">
                                                <h6 data-bind="text: part.DateEntered"></h6>
                                                <h6 data-bind="text: part.DatePODue"></h6>
                                                <h6 data-bind="text: part.PartType"></h6>
                                                <h6 data-bind="text: part.OnBoardClass"></h6>
                                            </div>*@



                                    </div>
                                    <div class="col-md-10" style="white-space: nowrap; overflow: hidden">
                                        <div class="onboard-tasks">
                                            <div data-bind="foreach: $root.OnboardingTasks()">
                                                <div data-bind="if: $data[0].OnBoardPart == $parent.RecordNumber">
                                                    <div data-bind="foreach: $data">
                                                        <div class="onboard-task-item no-select" data-bind="attr: {taskid: $data.RecordNumber, partid: $data.OnBoardPart}, css: {'onboard-task-complete' : CurrentStatus == 'Complete', 'onboard-task-complete-late' : CurrentStatus == 'Completed Late', 'onboard-task-late' : CurrentStatus == 'Late', 'onboard-task-upcoming' : CurrentStatus == 'Upcoming', 'onboard-task-in-progress' : CurrentStatus == 'In Progress', 'onboard-task-in-null' : CurrentStatus == '', 'blink blink-orange': DueBy == null && CompletedOn == null}">
                                                            <div data-bind="text: PercentComplete+'%'"></div>
                                                            <div data-bind="text: RecoveryDate == '' || RecoveryDate == null ? DueBy : RecoveryDate, enable: DelegatedTo == @ViewBag.UID || @ViewBag.RelPer == 18"></div>
                                                            <div data-bind="text: DelegatedToName"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ibox-footer">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="input-group" id="bldCustomer">
                                <span class="input-group-addon">Customer</span>
                                <input type="text" class="form-control typeahead" id="fltCustomer" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="input-group" id="bldProject">
                                <span class="input-group-addon">Project</span>
                                <input type="text" class="form-control typeahead" id="fltProject" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="input-group" id="bldPartType">
                                <span class="input-group-addon">Part Type</span>
                                <input type="text" class="form-control typeahead" id="fltPartType" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="input-group" id="bldPartClass">
                                <span class="input-group-addon">Part Class</span>
                                <input type="text" class="form-control" id="fltPartClass" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="input-group" id="bldPartNum">
                                <span class="input-group-addon">Part Num</span>
                                <input type="text" class="form-control typeahead" id="fltPartNum" />
                            </div>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-primary" id="btnFilter">Filter</button>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-danger" id="btnClearFilter">Clear</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<div class="modal inmodal fade" id="onboarding-part-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content" data-bind="if: SelectedPart()">
            <div class="modal-header">
                <h2 data-bind="text: SelectedPart().PartNumber"></h2>
                <h4 data-bind="text: SelectedPart().PartDescription"></h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-12">
                                <h3><label>Company: </label> <span data-bind="text: SelectedPart().Company"></span></h3>
                            </div>
                            <div class="col-md-12">
                                <h3><label>Date Due: </label> <span data-bind="text: SelectedPart().DatePODue"></span></h3>
                            </div>
                            <div class="col-md-12">
                                <h3><label>Date PO: </label> <span data-bind="text: SelectedPart().DatePOReceived"></span></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-12">
                                <h3><label>Job Number: </label> <span data-bind="text: SelectedPart().FirstArticleJobNumber"></span></h3>
                            </div>
                            <div class="col-md-12">
                                <h3><label>Package: </label> <span data-bind="text: SelectedPart().PackageName"></span></h3>
                            </div>
                            <div class="col-md-12">
                                <h3><label>Part Type: </label> <span data-bind="text: SelectedPart().PartType"></span></h3>
                            </div>
                            <div class="col-md-12">
                                <h3><label>Class: </label> <span data-bind="text: SelectedPart().OnBoardClass"></span></h3>
                            </div>
                        </div>
                    </div>
                </div>

            </div>


            <div class="modal-footer">
                <button type="button" class="btn btn-danger pull-left delete-part">Delete</button>
                <button type="button" class="btn btn-primary archive-part">Archive</button>
                
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal inmodal fade" id="onboarding-task-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" data-bind="if: SelectedTask()">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <center><h3 id="selected-part-number" data-bind="text: SelectedPart().PartNumber"></h3></center>
                        <center><h4 id="select-part-description" data-bind="text: SelectedPart().PartDescription"></h4></center>
                    </div>
                    <div class="col-md-4">
                        <center><h2 id="select-task-description" data-bind="text: SelectedTask().TaskDescription"></h2></center>
                        
                        <center>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group" style="width: 200px">
                                        <span class="input-group-addon">Due</span>
                                        <input type="text" class="form-control" id="TaskDue" data-provide="datepicker" data-bind="enable: SelectedPart().FirstArticleJobNumber == '' || SelectedPart().FirstArticleJobNumber == null, value: SelectedTask().DueBy" />

                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group" style="width: 200px">
                                        <span class="input-group-addon">Recovery</span>
                                        <input type="text" class="form-control" id="TaskRecovery" data-provide="datepicker" data-bind="value: SelectedTask().RecoveryDate" />

                                    </div>
                                </div>
                            </div>
                        </center>
                    </div>
                </div>
                <hr />
                <div class="row">
                    <div class="col-md-3">
                        Status: <span data-bind="text: SelectedTask().CurrentStatus == 'Complete' || SelectedTask().CurrentStatus == 'Completed Late' ? SelectedTask().CurrentStatus+' - '+SelectedTask().CompletedOn : SelectedTask().CurrentStatus"></span><br />
                        <span data-bind="text: SelectedTask().ActualCompletionHours+' / '+ SelectedTask().StandardCompletionHours+' Hours'"></span>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-addon">Perc. Comp.</span>
                            <input type="text" class="form-control" id="selectedPerct" maxlength="3" data-bind="value: SelectedTask().PercentComplete, enable: SelectedTask().DelegatedTo == @ViewBag.UID || @ViewBag.RelPer == 18" />
                        </div>
                        <br />
                        <div class="input-group">
                            <span class="input-group-addon">Delegate</span>
                            <select class="form-control" id="selectedDelegate" data-bind="enable: @ViewBag.RelPer == 18 || @ViewBag.UID == SelectedTask().ResponsibleUser">
                                <optgroup data-bind="foreach: Users()">
                                    <option data-bind="value: $data.ID, text: $data.FirstName+' '+$data.LastName"></option>
                                </optgroup>

                            </select>
                        </div>
                        <button class="btn btn-primary" id="saveChanges">Save</button>
                    </div>
                    <div class="col-md-6" style="border-left: 1px solid black">
                        <div class="row">
                            <div class="col-md-8">
                                <div id="del-comments-section" class="" style="height: 300px; overflow:auto;">
                                    <div @*data-bind="if: UserAccess"*@>
                                        <div data-bind="if: Comments().length < 1"><h3>No Comments Yet.</h3></div>
                                        <div data-bind="foreach: Comments">
                                            <div class="row comment-item" data-bind="attr: {commentid: $data.ID, userid: $data.UserID}">
                                                <div class="col-md-12">
                                                    <div class="row">
                                                        <div class="col-md-6"><span id="commenter-name" data-bind="text: $data.FirstName+' '+$data.LastName"></span> - <small><span data-bind="text: $data.TimeSubmitted" class="comment-time"></span> <span data-bind="if: ($data.UserID == @ViewBag.UID || @ViewBag.RelPer == 3)"><i data-bind="attr :{commentID: $data.ID}" class="fa fa-pencil hover-add edit-comment"></i><i data-bind="attr :{commentID: $data.ID}" class="fa fa-save hover-add save-comment hidden"></i> <i data-bind="attr: {commentid: $data.ID}" class="fa fa-close hover-rem remove-comment"></i></span></small></div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-10 col-md-offset-1 comment-text" data-bind="text: $data.CommentText"></div>
                                                        <div class="col-md-10 col-md-offset-1">
                                                            <textarea class="form-control txt-comment-edit hidden" data-bind="text: $data.CommentText"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4" style="border-left: 1px dashed #a9a9a9;">
                                <form id="frm-new-comment">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <textarea id="txt-new-comment" style="height:250px" name="Comment" class="form-control" placeholder="Enter Comment Here..."></textarea>
                                        </div>
                                    </div>
                                    <br />
                                    <div class="row">
                                        <div class="col-md-3 pull-right">
                                            <button type="button" id="btn-submit-comment" class="btn btn-primary pull-right">Submit</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>


            </div>


            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="menu-avail-jobs" hidden>
    <h3>Select a Job to assign to <span id="AssigningPartNumber">X</span></h3>
    <table class="table table-condensed table-striped">
        <thead>
            <tr>
                <th>Job</th>
                <th>Suffix</th>
                <th>DateStart</th>
                <th>Part</th>
            </tr>
        </thead>
        <tbody data-bind="foreach: AvailJobs()">
            <tr class="avail-job-item" data-bind="attr: {jobsuf: $data.Job+$data.Suffix}">
                <td data-bind="text: $data.Job"></td>
                <td data-bind="text: $data.Suffix"></td>
                <td data-bind="text: $data.Date_Start"></td>
                <td data-bind="text: $data.Part"></td>
            </tr>
        </tbody>
    </table>
</div>

<div class="hidden">
    <input type="text" id="RelPer" name="RelPer" value="@ViewBag.RelPer" />

</div>

@section Scripts{

    <script src="~/Scripts/KO-Models/ko-model-onboarding.js"></script>


    <script>


        var vm = null;

        $(function () {
            var AssignBtn = null;

            vm = new OnboardingViewModel();
            ko.applyBindings(vm);
            vm.loadUsers();
            vm.LoadOnboardingParts();
            
            //Delete part click event
            $(document).on('click', '.delete-part', function () {
                swal({
                    title: "Are you sure you want to DELETE this Part?",
                    text: "You will be unable to recover it.",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonClass: "btn-primary",
                    confirmButtonText: "Yes!",
                    closeOnConfirm: false
                },
                function () {
                    vm.DeletePart(vm.SelectedPart().RecordNumber);
                    swal({
                        title: "Deleted!",
                        type: "success",
                        timer: 1000
                    });
                });
            });

            //Archive part click event
            $(document).on('click', '.archive-part', function () {
                swal({
                    title: "Are you sure you want to ARCHIVE this Part?",
                    text: "It will be found under the History tab.",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonClass: "btn-primary",
                    confirmButtonText: "Yes!",
                    closeOnConfirm: false
                },
                function () {
                    vm.ArchivePart(vm.SelectedPart().RecordNumber);
                    swal({
                        title: "Archived!",
                        type: "success",
                        timer: 1000
                    });
                });
            });

            $(document).on('click', '.onboard-task-item', function () {
                var TaskID = $(this).attr('taskid');
                var PartID = $(this).attr('partid');
                vm.SelectTask(TaskID, PartID);
                vm.loadComments();
                //$('#task-detail').show('slide', { direction: 'right' }, '250');
                $('#onboarding-task-modal').modal('show');
            });

            $(document).on('click', '#saveChanges', function () {
                vm.SelectedTask().DueBy = $('#TaskDue').val();
                vm.SelectedTask().RecoveryDate = $('#TaskRecovery').val();
                vm.SaveChanges();
            });

            $(document).on('click', '#selectedDelegate', function () {
                var newDelegate = $(this).val();
                vm.SelectedTask().DelegatedTo = newDelegate;
            });

            $(document).on('focusout', '#selectedPerct', function () {
                var newPerct = parseInt($(this).val());
                if (newPerct == 100) {
                    vm.SelectedTask().CompletedBy = $('#layoutUserID').val();
                }
                vm.SelectedTask().PercentComplete = newPerct;
            });

            $(document).on('keydown', '#selectedPerct', function (e) {

                // Allow: backspace, delete, tab, escape, enter and .
                if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                    // Allow: Ctrl+A
                    (e.keyCode == 65 && e.ctrlKey === true) ||
                    // Allow: Ctrl+C
                    (e.keyCode == 67 && e.ctrlKey === true) ||
                    // Allow: Ctrl+X
                    (e.keyCode == 88 && e.ctrlKey === true) ||
                    // Allow: home, end, left, right
                    (e.keyCode >= 35 && e.keyCode <= 39)) {
                    // let it happen, don't do anything
                    return;
                }
                // Ensure that it is a number and stop the keypress
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }

            });
            $(document).on('keyup', '#selectedPerct', function (e) {
                if (parseInt($(this).val()) > 100) {
                    $(this).val($(this).val().substr(0, 2));

                }
            });

            $(document).on('click', '.part-detail', function (e) {
                var id = $(this).attr('partid');
                console.log(id);
                vm.SelectPart(id);
                $('#onboarding-part-modal').modal('show');
            });

            $(document).on('click', '.btn-assign-job', function (e) {
                AssignBtn = $(this);
                var PartID = $(this).attr('partid');
                var PartNumber = $(this).attr('partnumber');
                $('#AssigningPartNumber').html(PartNumber);
                $('#AssigningPartNumber').attr('PartID', PartID);
                console.log(PartID);
                vm.LoadAvailJobs(PartID);
                $('#menu-avail-jobs').hide('slow');
                $('#menu-avail-jobs').css({ 'top': e.pageY, 'left': e.pageX, 'position': 'absolute', 'border': '1px solid black', 'padding': '5px', 'width': '600px', 'background-color': '#f3f3f3' });
                $('#menu-avail-jobs').show('slow');
            });

            $(document).on('dblclick', '.avail-job-item', function () {
                var Job = $(this).attr('jobsuf');
                var PartID = $('#AssigningPartNumber').attr('partID');
                swal({
                    title: "Assign?",
                    text: "Are you sure you want to assign this job?",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonClass: "btn-primary",
                    confirmButtonText: "Yes!",
                    closeOnConfirm: false
                },
                function () {
                    vm.AssignJob(PartID, Job);
                    AssignBtn.parent().html(Job);
                    swal({
                        title: "Assigned!",
                        type: "success",
                        timer: 1000
                    });
                });
            });


            $(document).mouseup(function (e) {
                var container = $("#menu-avail-jobs");

                if (!container.is(e.target) // if the target of the click isn't the container...
                    && container.has(e.target).length === 0) // ... nor a descendant of the container
                {
                    container.hide();
                }
            });



            $(document).on('click', "#btn-submit-comment", function () {
                vm.addComment();
            });
            $(document).on('click', '.edit-comment', function () {
                var e = $(this);//.parent().parent().parent();
                id = e.attr('commentid');
                userid = e.attr('userid');

                comLabel = $(".comment-item[commentID='" + id + "']").find('.comment-text');
                txtBox = $(".comment-item[commentID='" + id + "']").find('.txt-comment-edit');
                comTime = $(".comment-item[commentID='" + id + "']").find('.comment-time');
                edit = $(".comment-item[commentID='" + id + "']").find('.edit-comment');
                save = $(".comment-item[commentID='" + id + "']").find('.save-comment');
                save.removeClass("hidden");
                edit.addClass("hidden");
                comLabel.addClass("hidden");
                txtBox.removeClass("hidden");
                txtBox.focus();

                txtBox.unbind().on("focusout", function () {
                    edit.removeClass("hidden");
                    save.addClass("hidden");
                    updatedText = txtBox.val();
                    comLabel.html(updatedText);
                    txtBox.addClass("hidden");
                    comLabel.removeClass("hidden");
                    updatedTime = DateNowFormatted();
                    comTime.html(updatedTime.split(" ")[0] + " @@ " + updatedTime.split(" ")[1]);

                    vm.updateComment(id, updatedTime, updatedText);

                });



            });



            $(document).on('click', '.remove-comment', function () {
                var id = $(this).attr('commentid');
                swal({
                    title: "Delete?",
                    text: "Are you sure you want to delete this comment?",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonClass: "btn-primary",
                    confirmButtonText: "Yes, delete it!",
                    closeOnConfirm: false
                },
                function () {
                    vm.removeComment(id);
                    swal({
                        title: "Deleted!",
                        type: "success",
                        timer: 1000
                    });
                });

            });

            $(document).on('click', '#btnFilter', function () {
                var Customer = $('#fltCustomer').val().toUpperCase();
                var Project = $('#fltProject').val().toUpperCase();
                var PartType = $('#fltPartType').val().toUpperCase();
                var PartClass = $('#fltPartClass').val().toUpperCase();
                var PartNum = $('#fltPartNum').val().toUpperCase();

                vm.FilterParts(Customer, Project, PartType, PartClass, PartNum);
            });

            $(document).on('click', '#btnClearFilter', function () {
                $('#fltCustomer').val('');
                $('#fltProject').val('');
                $('#fltPartType').val('');
                $('#fltPartClass').val('');
                $('#fltPartNum').val('');
                vm.ClearFilters();
            });

            // constructs the suggestion engine
            vm.Customers(new Bloodhound({ datumTokenizer: Bloodhound.tokenizers.whitespace, queryTokenizer: Bloodhound.tokenizers.whitespace, }));
            $('#bldCustomer .typeahead').typeahead({ hint: true, highlight: true, minLength: 1 }, { name: 'Customers', source: vm.Customers() });

            vm.Projects(new Bloodhound({ datumTokenizer: Bloodhound.tokenizers.whitespace, queryTokenizer: Bloodhound.tokenizers.whitespace, }));
            $('#bldProject .typeahead').typeahead({ hint: true, highlight: true, minLength: 1 }, { name: 'Projects', source: vm.Projects() });

            vm.PartTypes(new Bloodhound({ datumTokenizer: Bloodhound.tokenizers.whitespace, queryTokenizer: Bloodhound.tokenizers.whitespace, }));
            $('#bldPartType .typeahead').typeahead({ hint: true, highlight: true, minLength: 1 }, { name: 'PartTypes', source: vm.PartTypes() });

            vm.PartClasses(new Bloodhound({ datumTokenizer: Bloodhound.tokenizers.whitespace, queryTokenizer: Bloodhound.tokenizers.whitespace, }));
            $('#bldPartClass .typeahead').typeahead({ hint: true, highlight: true, minLength: 1 }, { name: 'PartClasses', source: vm.PartClasses() });

            vm.PartNums(new Bloodhound({ datumTokenizer: Bloodhound.tokenizers.whitespace, queryTokenizer: Bloodhound.tokenizers.whitespace, }));
            $('#bldPartNum .typeahead').typeahead({ hint: true, highlight: true, minLength: 1 }, { name: 'PartNums', source: vm.PartNums() });
        });
    </script>
}
