
@{
    ViewBag.Title = "Index";
}

<div class="row">
    <div class="col-lg-12">
        <div class="wrapper wrapper-content animated fadeInUp" style="padding-bottom: 0;">

            <div class="ibox">
                <div class="ibox-title">
                    <h5>Onboarding</h5>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-md-10 col-md-offset-2">
                            <div data-bind="foreach: {data: OnboardingTasks()[0]}">
                                <div class="onboard-task-header" data-bind="text: TaskDescription"></div>
                            </div>
                        </div>
                    </div>
                    <div style="height: 800px; white-space: nowrap;">
                        <div class="full-height-scroll">
                            <div data-bind="foreach: {data: OnboardingParts(), as: 'part' }">
                                <div class="row onboard-part-item" >
                                    <div class="col-md-2">
                                        <div style="float: left">
                                            <div style="width: 120px; height: 20px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">
                                                <h5 data-bind="text: part.PartNumber"></h5>
                                            </div>
                                            <div style="width: 120px; height: 20px; text-overflow: ellipsis;white-space: nowrap; overflow: hidden;">
                                                <h5 data-bind="text: part.PartDescription"></h5>
                                            </div>
                                            <div style="width: 120px; height: 20px; text-overflow: ellipsis;white-space: nowrap; overflow: hidden;">
                                                <span data-bind="text: part.FirstArticleJobNumber"></span>
                                            </div>
                                        </div>
                                        <div style="width: 60px; height: 80px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;float: left; padding: 0 5px;">
                                            <h6 data-bind="text: part.DateEntered"></h6>
                                            <h6 data-bind="text: part.DatePODue"></h6>
                                            <h6 data-bind="text: part.PartType"></h6>
                                            <h6 data-bind="text: part.OnBoardClass"></h6>
                                        </div>



                                    </div>
                                    <div class="col-md-10" style="white-space: nowrap; overflow: hidden">
                                        <div class="onboard-tasks">
                                            <div data-bind="foreach: $root.OnboardingTasks()">
                                                <div data-bind="if: $data[0].OnBoardPart == $parent.RecordNumber">
                                                    <div data-bind="foreach: $data">
                                                        <div class="onboard-task-item no-select" data-bind="attr: {taskid: $data.RecordNumber, partid: $data.OnBoardPart}, css: {'onboard-task-complete' : CurrentStatus == 'Complete', 'onboard-task-complete-late' : CurrentStatus == 'Completed Late', 'onboard-task-late' : CurrentStatus == 'Late', 'onboard-task-upcoming' : CurrentStatus == 'Upcoming', 'onboard-task-in-progress' : CurrentStatus == 'In Progress', 'onboard-task-in-null' : CurrentStatus == ''}">
                                                            <div data-bind="text: PercentComplete+'%'"></div>
                                                            <div data-bind="text: DueBy"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


<div class="modal inmodal fade" id="onboarding-task-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" data-bind="if: SelectedTask()">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <center><h3 id="selected-part-number" data-bind="text: SelectedPart().PartNumber"></h3></center>
                        <center><h4 id="select-part-description" data-bind="text: SelectedPart().PartDescription"></h4></center>
                    </div>
                    <div class="col-md-4">
                        <center><h2 id="select-task-description" data-bind="text: SelectedTask().TaskDescription"></h2></center>
                        <center><h3 id="select-task-due" data-bind="text: 'Due: '+SelectedTask().DueBy"></h3></center>
                    </div>
                </div>
                <hr />
                <div class="row">
                    <div class="col-md-3">
                        Status: <span data-bind="text: SelectedTask().CurrentStatus == 'Complete' || SelectedTask().CurrentStatus == 'Completed Late' ? SelectedTask().CurrentStatus+' - '+SelectedTask().CompletedOn : SelectedTask().CurrentStatus"></span><br />
                        <span data-bind="text: SelectedTask().ActualCompletionHours+' / '+ SelectedTask().StandardCompletionHours+' Hours'"></span>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-addon">Perc. Comp.</span>
                            <input type="text" class="form-control" id="selectedPerct" maxlength="3" data-bind="value: SelectedTask().PercentComplete" />
                        </div>
                        <br />
                        <div class="input-group">
                            <span class="input-group-addon">Delegate</span>
                            <select class="form-control" id="selectedDelegate">
                                <optgroup data-bind="foreach: Users()">
                                    <option data-bind="value: $data.ID, text: $data.FirstName+' '+$data.LastName"></option>
                                </optgroup>

                            </select>
                        </div>
                        <button class="btn btn-primary" id="saveChanges">Save</button>
                    </div>
                    <div class="col-md-6" style="border-left: 1px solid black">
                        <div class="row comment-section">
                            <div class="col-md-8">
                                <div id="del-comments-section" class="" style="height: 300px; overflow:auto;">
                                    <div  @*data-bind="if: UserAccess"*@>
                                        <div data-bind="if: Comments().length < 1"><h3>No Comments Yet.</h3></div>
                                        <div data-bind="foreach: Comments">
                                            <div class="row comment-item" data-bind="attr: {commentid: $data.ID, userid: $data.UserID}">
                                                <div class="col-md-12">
                                                    <div class="row">
                                                        <div class="col-md-6"><span id="commenter-name" data-bind="text: $data.FirstName+' '+$data.LastName"></span> - <small><span data-bind="text: $data.TimeSubmitted" class="comment-time"></span> <span data-bind="if: ($data.UserID == @ViewBag.UID || @ViewBag.RelPer == 3)"><i data-bind="attr :{commentID: $data.ID}" class="fa fa-pencil hover-add edit-comment"></i><i data-bind="attr :{commentID: $data.ID}" class="fa fa-save hover-add save-comment hidden"></i> <i data-bind="attr: {commentid: $data.ID}" class="fa fa-close hover-rem remove-comment"></i></span></small></div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-10 col-md-offset-1 comment-text" data-bind="text: $data.CommentText"></div>
                                                        <div class="col-md-10 col-md-offset-1">
                                                            <textarea class="form-control txt-comment-edit hidden" data-bind="text: $data.CommentText"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4" style="border-left: 1px dashed #a9a9a9;">
                                <form id="frm-new-comment">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <textarea id="txt-new-comment" style="height:250px" name="Comment" class="form-control" placeholder="Enter Comment Here..."></textarea>
                                        </div>
                                    </div>
                                    <br />
                                    <div class="row">
                                        <div class="col-md-3 pull-right">
                                            <button type="button" id="btn-submit-comment" class="btn btn-primary pull-right">Submit</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                  
            </div>


            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="hidden">
    <input type="text" id="RelPer" name="RelPer" value="@ViewBag.RelPer" />

</div>

@section Scripts{

    <script src="~/Scripts/KO-Models/ko-model-onboarding.js"></script>


    <script>


        var vm = null;

        $(function () {


            vm = new OnboardingViewModel();
            ko.applyBindings(vm);
            vm.loadUsers();
            vm.LoadOnboardingParts();

            $(document).on('click', '.onboard-task-item', function () {
                var TaskID = $(this).attr('taskid');
                var PartID = $(this).attr('partid');
                vm.SelectTask(TaskID, PartID);
                vm.loadComments();
                //$('#task-detail').show('slide', { direction: 'right' }, '250');
                $('#onboarding-task-modal').modal('show');
            });

            $(document).on('click', '#saveChanges', function () {
                vm.SaveChanges();
            });

            $(document).on('click', '#selectedDelegate', function () {
                var newDelegate = $(this).val();
                vm.SelectedTask().DelegatedTo = newDelegate;
            });

            $(document).on('focusout', '#selectedPerct', function () {
                var newPerct = parseInt($(this).val());
                vm.SelectedTask().PercentComplete = newPerct;
            });

            $(document).on('keydown', '#selectedPerct', function (e) {
                
                // Allow: backspace, delete, tab, escape, enter and .
                if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                    // Allow: Ctrl+A
                    (e.keyCode == 65 && e.ctrlKey === true) ||
                    // Allow: Ctrl+C
                    (e.keyCode == 67 && e.ctrlKey === true) ||
                    // Allow: Ctrl+X
                    (e.keyCode == 88 && e.ctrlKey === true) ||
                    // Allow: home, end, left, right
                    (e.keyCode >= 35 && e.keyCode <= 39)) {
                    // let it happen, don't do anything
                    return;
                }
                // Ensure that it is a number and stop the keypress
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
                
            });
            $(document).on('keyup', '#selectedPerct', function (e) {
                if (parseInt($(this).val()) > 100) {
                    $(this).val($(this).val().substr(0, 2));
                    
                }
            });











            $(document).on('click', "#btn-submit-comment", function () {
                vm.addComment();
            });
            $(document).on('click', '.edit-comment', function () {
                var e = $(this);//.parent().parent().parent();
                id = e.attr('commentid');
                userid = e.attr('userid');

                comLabel = $(".comment-item[commentID='" + id + "']").find('.comment-text');
                txtBox = $(".comment-item[commentID='" + id + "']").find('.txt-comment-edit');
                comTime = $(".comment-item[commentID='" + id + "']").find('.comment-time');
                edit = $(".comment-item[commentID='" + id + "']").find('.edit-comment');
                save = $(".comment-item[commentID='" + id + "']").find('.save-comment');
                save.removeClass("hidden");
                edit.addClass("hidden");
                comLabel.addClass("hidden");
                txtBox.removeClass("hidden");
                txtBox.focus();

                txtBox.unbind().on("focusout", function () {
                    edit.removeClass("hidden");
                    save.addClass("hidden");
                    updatedText = txtBox.val();
                    comLabel.html(updatedText);
                    txtBox.addClass("hidden");
                    comLabel.removeClass("hidden");
                    updatedTime = DateNowFormatted();
                    comTime.html(updatedTime.split(" ")[0] + " @@ " + updatedTime.split(" ")[1]);

                    vm.updateComment(id, updatedTime, updatedText);

                });



            });



            $(document).on('click', '.remove-comment', function () {
                var id = $(this).attr('commentid');
                swal({
                    title: "Delete?",
                    text: "Are you sure you want to delete this comment?",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonClass: "btn-primary",
                    confirmButtonText: "Yes, delete it!",
                    closeOnConfirm: false
                },
                function () {
                    vm.removeComment(id);
                    swal({
                        title: "Deleted!",
                        type: "success",
                        timer: 1000
                    });
                });

            });
        });
    </script>
}
